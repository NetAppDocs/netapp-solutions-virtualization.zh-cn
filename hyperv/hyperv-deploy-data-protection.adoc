---
sidebar: sidebar 
permalink: hyperv/hyperv-deploy-data-protection.html 
keywords: hyperv, hyper-v, deploy, netapp, virtualization, data, protection 
summary: 该解决方案提供了在NetApp存储上部署 Hyper-V 所需的步骤 
---
= 在NetApp存储上部署 Microsoft Hyper-V
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
使用基于ONTAP存储的解决方案和第三方备份集成部署 Microsoft Hyper-V 虚拟机。此过程包括使用ONTAP Snapshot 副本和FlexClone技术进行快速备份和恢复操作、配置 CommVault IntelliSnap 进行企业备份管理以及实施SnapMirror复制以进行跨站点的备份和灾难恢复。

学习解决独特的 Hyper-V 备份考虑因素（例如集群环境中的磁盘 ID 冲突）并优化独立主机和 Hyper-V 集群的数据保护。



== 使用NetApp存储快照进行恢复

备份虚拟机并快速恢复或克隆它们是ONTAP卷的一大优势。使用 Snapshot 副本快速制作虚拟机甚至整个 CSV 卷的FlexClone副本，而不会影响性能。这样，在克隆生产数据卷并将其安装在 QA、暂存和开发环境中时，就可以处理生产数据，而不会有数据损坏的风险。  FlexClone卷可用于制作生产数据的测试副本，而无需将复制数据所需的空间量增加一倍。

请记住，Hyper-V 节点为每个磁盘分配一个唯一的 ID，并且对具有相应分区（MBR 或 GPT）的卷进行快照将具有相同的唯一标识。 MBR 使用磁盘签名，而 GPT 使用 GUID（全局唯一标识符）。对于独立的 Hyper-V 主机，可以轻松安装FlexClone卷而不会发生任何冲突。这是因为独立的 Hyper-V 服务器可以自动检测重复的磁盘 ID 并在无需用户干预的情况下动态更改它们。该方法可用于根据场景需求通过复制 VHD 来恢复 VM。

虽然对于独立的 Hyper-V 主机来说很简单，但对于 Hyper-V 集群来说，过程有所不同。恢复过程包括将FlexClone卷映射到独立的 Hyper-V 主机或使用 diskpart 通过将FlexClone卷映射到独立的 Hyper-V 主机来手动更改签名（这很重要，因为磁盘 ID 冲突会导致无法使磁盘联机）完成后，将FlexClone卷映射到集群。



== 使用第三方解决方案备份和恢复

*注意*：本节使用 Commvault，但这也适用于其他第三方解决方案。

CommVault IntelliSnap 利用ONTAP快照技术，创建基于硬件的 Hyper-V 快照。备份可以根据 Hyper-V 虚拟机管理程序或虚拟机组的配置自动执行，也可以针对虚拟机组或特定虚拟机手动执行。  IntelliSnap 能够快速保护 Hyper-V 环境，最大限度地减少生产虚拟化场的负载。 IntelliSnap 技术与虚拟服务器代理 (VSA) 的集成使NetApp ONTAP阵列能够在几分钟内完成大量虚拟机和数据存储的备份。细粒度访问提供从存储的二级层恢复单个文件和文件夹以及完整的来宾 .vhd 文件。

在配置虚拟化环境之前，部署需要快照与阵列集成的适当代理。  Microsoft Hyper-V 虚拟化环境需要以下代理：

* 媒体代理
* 虚拟服务器代理 (VSA)
* VSS 硬件提供商（Windows Server 2012 及更新操作系统）


*使用阵列管理配置NetApp阵列*

以下步骤显示如何在利用ONTAP阵列和 Hyper-V 的环境中配置 IntelliSnap 虚拟机备份。

. 在 CommCell Console 的功能区上，单击“存储”选项卡，然后单击“阵列管理”。
. 出现阵列管理对话框。
. 单击“添加”。
+
出现阵列属性对话框。

+
image:hyperv-deploy-009.png["阵列属性对话框的图像"]

. 在常规选项卡上，指定以下信息：
. 从 Snap 供应商列表中，选择NetApp。
. 在名称框中，输入主文件服务器的主机名、完全限定域名 (FQDN) 或 TCP/IP 地址。
. 在阵列访问节点选项卡上，选择可用的介质代理。
. 在“Snap Configuration”选项卡上，根据需要配置“Snapshot Configuration Properties”。
. 单击“OK”。
. <强制步骤> 完成后，还要在NetApp存储阵列上配置 SVM，使用检测选项自动检测存储虚拟机 (SVM)，然后选择一个 SVM，并使用添加选项将该 SVM 添加到 CommServe 数据库中，作为阵列管理条目。
+
image:hyperv-deploy-010.png["将 SVM 配置为阵列管理条目的图像"]

. 单击“高级”（如下图所示）并选中“启用 IntelliSnap”复选框。
+
image:hyperv-deploy-011.png["显示启用 IntelliSnap 选项的图像"]



有关配置数组的详细步骤，请参阅 link:https://documentation.commvault.com/v11/commcell-console/configuring_netapp_array_using_array_management.html["配置NetApp阵列"] 和 link:https://documentation.commvault.com/v11/commcell-console/configure_storage_virtual_machine_on_netapp_storage_array.html["在NetApp阵列上配置存储虚拟机"]

*添加 Hyper-V 作为虚拟机管理程序*

下一步是添加 Hyper-V 虚拟机管理程序并添加 VM 组。

*先决条件*

* 虚拟机管理程序可以是 Hyper-V 群集、群集中的 Hyper-V 服务器或独立的 Hyper-V 服务器。
* 对于 Hyper-V Server 2012 及更高版本，用户必须属于 Hyper-V 管理员组。对于 Hyper-V 集群，用户帐户必须具有完全集群权限（读取和完全控制）。
* 确定将安装虚拟服务器代理 (VSA) 的一个或多个节点，以创建用于备份和还原操作的访问节点（VSA 代理）。要发现 Hyper-V 服务器，CommServe 系统必须安装 VSA。
* 要对 Hyper-V 2012 R2 使用更改块跟踪，请选择 Hyper-V 群集中的所有节点。


以下步骤显示如何添加 Hyper-V 作为虚拟机管理程序。

. 核心设置完成后，在“保护”选项卡上，单击“虚拟化”图块。
. 在创建服务器备份计划页面上，键入计划的名称，然后提供有关存储、保留和备份计划的信息。
. 现在出现添加虚拟机管理程序页面 > 选择供应商：选择 Hyper-V（输入 IP 地址或 FQDN 和用户凭据）
. 对于 Hyper-V 服务器，单击发现节点。填充“节点”字段后，选择要安装虚拟服务器代理的一个或多个节点。
+
image:hyperv-deploy-012.png["显示 Hyper-V 节点发现的图像"]

. 单击“下一步”并“保存”。
+
image:hyperv-deploy-013.png["该图显示了上一步的结果"]

. 在添加 VM 组页面上，选择要保护的虚拟机（在本例中 Demogrp 是创建的 VM 组）并启用 IntelliSnap 选项，如下所示。
+
image:hyperv-deploy-014.png["该图显示了要保护的虚拟机的选择"]

+
*注意*：当在 VM 组上启用 IntelliSnap 时，Commvault 会自动为主要（快照）和备份副本创建计划策略。

. 单击“Save”。


有关配置阵列的详细步骤，请参阅link:https://documentation.commvault.com/2023e/software/guided_setup_for_hyper_v.html["HyperV 的引导设置"]。

*执行备份：*

. 从导航窗格中，转到保护 > 虚拟化。出现虚拟机页面。
. 备份虚拟机或虚拟机组。在这个演示中，选择了VM组。在 VM 组行中，单击操作按钮 action_button，然后选择备份。在这种情况下，nimplan 是与 Demogrp 和 Demogrp01 相关联的计划。
+
image:hyperv-deploy-015.png["显示选择要备份的虚拟机的对话框的图像"]

. 一旦备份成功，还原点即可使用，如屏幕截图所示。从快照副本中，可以执行完整 VM 的还原以及客户文件和文件夹的还原。
+
image:hyperv-deploy-016.png["显示备份的还原点的图像"]

+
*注意*：对于关键且使用率较高的虚拟机，每个 CSV 保留较少的虚拟机。



*执行恢复操作：*

通过还原点还原完整的虚拟机、客户文件和文件夹或虚拟磁盘文件。

. 从导航窗格中，转到保护>虚拟化，将出现虚拟机页面。
. 单击虚拟机组选项卡。
. 出现 VM 组页面。
. 在虚拟机组区域，单击包含虚拟机的虚拟机组的恢复。
. 出现“选择还原类型”页面。
+
image:hyperv-deploy-017.png["该图显示了备份的还原类型"]

. 根据选择选择客户文件或完整虚拟机并触发恢复。
+
image:hyperv-deploy-018.png["显示恢复选项的图像"]



有关所有受支持的还原选项的详细步骤，请参阅link:https://documentation.commvault.com/2023e/software/restores_for_hyper_v.html["Hyper-V 还原"]。



== 高级NetApp ONTAP选项

NetApp SnapMirror支持高效的站点到站点存储复制，使灾难恢复快速、可靠且易于管理，适合当今的全球企业。 SnapMirror可通过 LAN 和 WAN 高速复制数据，为关键任务应用程序提供高数据可用性和快速恢复，以及出色的存储重复数据删除和网络压缩功能。借助NetApp SnapMirror技术，灾难恢复可以保护整个数据中心。卷可以逐步备份到异地位置。 SnapMirror按照所需的 RPO 频率执行增量、基于块的复制。块级更新减少了带宽和时间要求，并在 DR 站点保持了数据一致性。

一个重要的步骤是创建整个数据集的一次性基线传输。这是执行增量更新之前所必需的。此操作包括在源处创建 Snapshot 副本并将其引用的所有数据块传输到目标文件系统。初始化完成后，可以进行计划或手动触发的更新。每次更新仅将新的和更改的块从源传输到目标文件系统。此操作包括在源卷上创建 Snapshot 副本，将其与基线副本进行比较，然后仅将更改的块传输到目标卷。新的副本将成为下一次更新的基线副本。由于复制是定期的，因此SnapMirror可以整合更改的块并节省网络带宽。对写入吞吐量和写入延迟的影响很小。

通过完成以下步骤来执行恢复：

. 连接到辅助站点上的存储系统。
. 中断SnapMirror关系。
. 将SnapMirror卷中的 LUN 映射到辅助站点上的 Hyper-V 服务器的启动器组 (igroup)。
. 一旦 LUN 映射到 Hyper-V 集群，就使这些磁盘联机。
. 使用故障转移群集 PowerShell cmdlet，将磁盘添加到可用存储并将其转换为 CSV。
. 将 CSV 中的虚拟机导入 Hyper-V 管理器，使其具有高可用性，然后将其添加到集群中。
. 打开虚拟机。

