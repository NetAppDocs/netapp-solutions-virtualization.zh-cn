---
sidebar: sidebar 
permalink: hyperv/hyperv-deploy-considerations.html 
keywords: hyperv, hyper-v, deploy, netapp, virtualization, consideration 
summary: 该解决方案提供了在NetApp存储上部署 Hyper-V 所需的步骤 
---
= 适用于 Microsoft Hyper-V 和ONTAP存储系统的部署指南
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
为了确保在使用ONTAP存储部署 Microsoft Hyper-V 时获得最佳性能和可靠性，请考虑工作负载兼容性、存储大小和 VM 资源分配等因素。兼容性检查应包括操作系统版本、应用程序、数据库和任何现有定制，以确保在 Hyper-V 环境中顺利运行。



== 正确调整存储大小

在部署工作负载或从现有虚拟机管理程序迁移之前，请确保工作负载的大小能够满足所需的性能。这可以通过收集每个单独的 VM 的性能数据轻松完成，这些数据收集 CPU（已使用/已配置）、内存（已使用/已配置）、存储（已配置/已利用）、网络吞吐量和延迟的统计信息以及读/写 IOP、吞吐量和块大小的聚合。这些参数对于成功部署以及正确确定存储阵列和工作负载主机的大小是必需的。

*注意*：在为 Hyper-V 和相关工作负载调整存储大小时，请规划 IOPS 和容量。

*注意*：对于 I/O 密集型虚拟机或需要大量资源和容量的虚拟机，请分离操作系统和数据磁盘。操作系统和应用程序二进制文件很少更改，并且卷崩溃一致性是可以接受的。

*注意*：使用来宾连接存储（又名来宾内）来获得高性能数据磁盘，而不是使用 VHD。这也有助于简化克隆过程。



== 增强虚拟机性能

选择适当数量的 RAM 和 vCPU 以获得最佳性能，并将多个磁盘连接到单个虚拟 SCSI 控制器。仍然建议使用固定 VHDx 作为部署虚拟磁盘的主要选择，并且对使用任何类型的 VHDX 虚拟磁盘没有任何限制。

*注意*：避免在 Windows Server 上安装不需要的角色。

*注意*：选择 Gen2 作为能够从 SCSI 控制器加载 VM 的虚拟机的代数，并且基于 VMBUS 和 VSP / VSC 架构作为启动级别，这显著提高了整体 VM 性能。

*注意*：避免频繁进行检查点，因为这会对虚拟机的性能产生负面影响。



== SMB3.0的设计与考量

SMB 3.0 文件共享可用作 Hyper-V 的共享存储。ONTAPONTAP通过 SMB 共享为 Hyper-V 进行无中断操作。Hyper-V 可以使用 SMB 文件共享来存储虚拟机文件，例如配置、快照和虚拟硬盘 (VHD) 文件。使用专用ONTAP CIFS SVM 为 Hyper-V 提供基于 SMB3.0 的共享。用于存储虚拟机文件的卷必须使用 NTFS 安全模式卷创建。如果有 10GB 网络，建议使用 10GB 网络建立 Hyper-V 主机与NetApp阵列之间的连接。对于 1GB 网络连接， NetApp建议创建一个由多个 1GB 端口组成的接口组。将每个为 SMB 多通道提供服务的 NIC 连接到其专用 IP 子网，以便每个子网在客户端和服务器之间提供单一路径。

*要点*

* 在ONTAP SVM 上启用 SMB 多通道
* ONTAP CIFS SVM 在集群中的每个节点上应至少有一个数据 LIF。
* 所使用的共享必须配置持续可用的属性集。
* ONTAP One 现在包含在每个AFF （A 系列和 C 系列）、全 SAN 阵列 (ASA) 和FAS系统中。因此不需要单独的许可证。
* 对于共享 VHDx，使用来宾连接的 iSCSI LUN


*注意*：ODX 受支持并可跨协议工作。在文件共享和 iSCSI 或 FCP 连接的 LUN 之间复制数据也利用 ODX。

*注意*：集群中节点的时间设置应相应设置。如果NetApp CIFS 服务器必须参与 Windows Active Directory (AD) 域，则应使用网络时间协议 (NTP)。

*注意*：必须通过 CIFS 服务器启用较大的 MTU 值。较小的数据包可能会导致性能下降。



== 配置 SMB 卷

. 验证存储虚拟机 (SVM) 上是否启用了所需的 CIFS 服务器选项
. 以下选项应设置为 true：smb2-enabled、smb3-enabled、copy-offload-enabled、shadowcopy-enabled、is-multichannel-enabled、is-large-mtu-enabled
+
image:hyperv-deploy-003.png["SMB 列设置图像"]

. 在存储虚拟机 (SVM) 上创建 NTFS 数据卷，然后配置持续可用的共享以供 Hyper-V 使用
+
image:hyperv-deploy-004.png["NTFS 数据卷设置图像"]

+
*注意*：除非配置中使用的卷创建为 NTFS 安全样式卷，否则 Hyper-V 通过 SMB 的无中断操作无法正常工作。

. 启用持续可用性并在共享上配置 NTFS 权限以包含具有完全控制权的 Hyper-V 节点。
+
image:hyperv-deploy-005.png["NTFS 权限设置的图片"]



有关详细的最佳做法指导，请参阅link:https://docs.netapp.com/us-en/ontap-apps-dbs/microsoft/win_overview.html["Hyper-V 的部署指南和最佳实践"]。

有关更多信息，请参阅link:https://docs.netapp.com/us-en/ontap/smb-hyper-v-sql/server-volume-requirements-hyper-v-concept.html["Hyper-V over SMB 的 SMB 服务器和卷要求"]。



== 区块协议设计与考量

*要点*

* 在主机上使用多路径（MPIO）来管理多条路径。根据需要创建更多路径，以促进数据移动操作或利用额外的 I/O 资源，但不要超过主机操作系统可以支持的最大路径数。
* 在访问 LUN 的主机上安装主机实用程序工具包。
* 至少创建 8 个卷。


*注意*：每个卷使用一个 LUN，因此 LUN 与 CSV 的映射比率为 1:1。

* SVM 应该在每个要使用 iSCSI 或光纤通道提供数据的存储控制器上为每个以太网网络或光纤通道结构配备一个 LIF。
* 使用 FCP 或 iSCSI 提供数据的 SVM 需要 SVM 管理接口。




== 配置 ISCSI 卷

要配置 ISCSI 卷，请确保满足以下先决条件。

* 存储虚拟机 (SVM) 应启用 iSCSI 协议并创建适当的逻辑接口 (LIF)。
* 指定的聚合必须具有足够的可用空间来包含 LUN。


*注*：默认情况下， ONTAP使用选择性 LUN 映射 (SLM) 使 LUN 只能通过拥有该 LUN 的节点及其高可用性 (HA) 伙伴节点上的路径访问。

* 在每个节点上配置所有 iSCSI LIF 以实现 LUN 移动性，以防 LUN 移动到集群中的另一个节点。


*步骤*

. 使用系统管理器并导航到 LUN 窗口（ONTAP CLI 可用于相同操作）。
. 单击“创建”。
. 浏览并选择要创建 LUN 的指定 SVM，然后显示创建 LUN 向导。
. 在“常规属性”页面上，为包含 Hyper-V 虚拟机的虚拟硬盘 (VHD) 的 LUN 选择 Hyper-V。
+
image:hyperv-deploy-006.png["Hyper-V LUN 创建的常规属性页面图像"]

. <单击更多选项> 在 LUN 容器页面上，选择一个现有的FlexVol volume，否则将创建一个新卷。
. <单击更多选项> 在启动器映射页面上，单击添加启动器组，在常规选项卡上输入所需信息，然后在启动器选项卡上输入主机的 iSCSI 启动器节点名称。
. 确认详细信息，然后单击“完成”以完成向导。


创建 LUN 后，转到故障转移群集管理器。要将磁盘添加到 CSV，必须先将该磁盘添加到群集的可用存储组（如果尚未添加），然后将该磁盘添加到群集上的 CSV。

*注意*：故障转移群集中默认启用 CSV 功能。

*将磁盘添加到可用存储空间：*

. 在故障转移群集管理器的控制台树中，展开群集的名称，然后展开“存储”。
. 右键单击“磁盘”，然后选择“添加磁盘”。出现一个列表，显示可以添加用于故障转移群集的磁盘。
. 选择要添加的一个或多个磁盘，然后选择“确定”。
. 磁盘现已分配给可用存储组。
. 完成后，选择刚刚分配给可用存储的磁盘，右键单击选择，然后选择添加到群集共享卷。
+
image:hyperv-deploy-007.png["添加到集群共享卷界面的图片"]

. 磁盘现已分配给集群中的集群共享卷组。磁盘作为 %SystemDrive%ClusterStorage 文件夹下的编号卷（挂载点）向每个集群节点公开。这些卷出现在 CSVFS 文件系统中。


有关更多信息，请参阅link:https://learn.microsoft.com/en-us/windows-server/failover-clustering/failover-cluster-csvs#add-a-disk-to-csv-on-a-failover-cluster["在故障转移群集中使用群集共享卷"]。

创建高可用性虚拟机：

要创建高可用性虚拟机，请按照以下步骤操作：

. 在故障转移群集管理器中，选择或指定所需的群集。确保群集下的控制台树已展开。
. 单击角色。
. 在“操作”窗格中，单击“虚拟机”，然后单击“新建虚拟机”。出现新的虚拟机向导。单击“下一步”。
. 在指定名称和位置页面上，指定虚拟机的名称，例如 nimdemo。单击将虚拟机存储在其他位置，然后键入完整路径或单击浏览并导航到共享存储。
. 为与物理网络适配器关联的虚拟交换机分配内存并配置网络适配器。
. 在“连接虚拟硬盘”页面上，单击“创建虚拟硬盘”。
. 在“安装选项”页面上，单击从启动 CD/DVD-ROM 安装操作系统。在“媒体”下，指定媒体的位置，然后单击“完成”。
. 虚拟机已创建。然后，故障转移群集管理器中的高可用性向导会自动配置虚拟机以实现高可用性。




== 使用 ODX 功能快速配置虚拟磁盘

ONTAP中的 ODX 功能允许通过简单地复制ONTAP存储系统托管的主 VHDX 文件来制作主 VHDX 的副本。由于支持 ODX 的副本不会将任何数据放在网络上，因此复制过程发生在NetApp存储端，因此速度可提高六到八倍。快速配置的一般考虑包括存储在文件共享上的主系统准备映像和由 Hyper-V 主机启动的常规复制过程。

*注意*： ONTAP支持 SMB 和 SAN 协议的 ODX。

*注意*：要利用 Hyper-V 的 ODX 复制卸载直通用例，来宾操作系统必须支持 ODX，并且来宾操作系统的磁盘必须是由支持 ODX 的存储（SMB 或 SAN）支持的 SCSI 磁盘。客户操作系统上的 IDE 磁盘不支持 ODX 直通。



== 性能优化

虽然每个 CSV 的推荐虚拟机数量是主观的，但有许多因素决定了可以放置在每个 CSV 或 SMB 卷上的虚拟机的最佳数量。尽管大多数管理员只考虑容量，但发送到 VHDx 的并发 I/O 量是整体性能的最关键因素之一。控制性能的最简单方法是调节每个 CSV 或共享上放置的虚拟机的数量。如果并发虚拟机 I/O 模式向 CSV 或共享发送过多流量，则磁盘队列将被填满，并产生更高的延迟。



== SMB 卷和 CSV 大小

确保解决方案端到端大小足够以避免瓶颈，并且在为 Hyper-V VM 存储目的创建卷时，最佳做法是创建不大于所需大小的卷。正确调整卷大小可防止意外在 CSV 上放置过多的虚拟机，并降低资源争用的可能性。每个集群共享卷 (CSV) 支持一个或多个 VM。放置在 CSV 上的虚拟机数量取决于工作负载和业务偏好，以及如何使用ONTAP存储功能（例如快照和复制）。在大多数部署场景中，将多个虚拟机放置在 CSV 上是一个很好的起点。针对具体用例调整此方法以满足性能和数据保护要求。

由于卷和 VHDx 大小可以轻松增加，因此如果 VM 需要额外的容量，则无需将 CSV 的大小设置得大于所需。 Diskpart 可用于扩展 CSV 大小，或者更简单的方法是创建一个新的 CSV 并将所需的 VM 迁移到新的 CSV。为了获得最佳性能，最佳做法是增加 CSV 的数量，而不是增加其大小作为临时措施。



== 迁移

当前市场条件下最常见的用例之一是迁移。客户可以使用 VMM Fabric 或其他第三方迁移工具来迁移虚拟机。这些工具使用主机级复制将数据从源平台移动到目标平台，这可能会很耗时，具体取决于迁移范围内的虚拟机数量。

在这种情况下使用ONTAP可以比使用基于主机的迁移过程实现更快的迁移。 ONTAP还支持虚拟机从一个虚拟机管理程序快速迁移到另一个虚拟机管理程序（在本例中为 ESXi 到 Hyper-V）。在NetApp Storage 上，任何大小的 VMDK 都可以在几秒钟内转换为 VHDx。这就是我们的 PowerShell 方式 - 它利用NetApp FlexClone技术快速转换 VM 硬盘。它还处理目标和目标虚拟机的创建和配置。

此过程有助于最大限度地减少停机时间并提高业务生产力。它还通过降低许可成本、锁定和对单一供应商的承诺来提供选择和灵活性。对于希望优化 VM 许可成本和扩展 IT 预算的组织来说，这也大有裨益。

以下视频演示了将虚拟机从 VMware ESX 迁移到 Hyper-V 的过程。

.从 ESX 到 Hyper-V 的零接触迁移
video::f4bd0e96-9517-465a-be53-b16d00e305fe[panopto]
有关使用 Flexclone 和 PowerShell 进行迁移的更多信息，请参阅link:hyperv-deploy-script.html["用于迁移的 PowerShell 脚本"]。
