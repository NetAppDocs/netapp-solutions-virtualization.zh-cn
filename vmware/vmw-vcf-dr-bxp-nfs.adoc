---
sidebar: sidebar 
permalink: vmware/vmw-vcf-dr-bxp-nfs.html 
keywords: netapp, vmware, cloud, foundation, vcf, bluexp, disaster recovery, nfs 
summary: 使用BlueXP disaster recovery即服务的 VCF 灾难恢复解决方案。 
---
= 使用NetApp SnapMirror和BlueXP DRaaS 实施灾难恢复
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
使用NetApp SnapMirror和BlueXP DRaaS 为 NFS 数据存储提供 VCF 灾难恢复解决方案

从生产站点到灾难恢复 (DR) 站点的块级复制提供了一种有弹性且经济高效的策略，可保护工作负载免受站点中断和数据损坏事件（包括勒索软件攻击）的影响。  NetApp SnapMirror复制功能支持将在本地ONTAP系统上运行的 VMware VCF 9 工作负载域（使用 NFS 或 VMFS 数据存储区）复制到位于指定恢复数据中心的辅助ONTAP系统（该数据中心也部署了 VMware）。

本节概述了BlueXP灾难恢复即服务 (DRaaS) 的配置，以便为本地 VMware 虚拟机建立 DR。

设置包括：

* 创建BlueXP帐户并部署BlueXP连接器。
* 将ONTAP阵列添加到BlueXP画布以促进 VMware vCenter 和ONTAP存储之间的通信。
* 使用SnapMirror配置站点之间的复制。
* 设置并测试恢复计划以验证故障转移准备情况。


BlueXP disaster recovery服务集成在NetApp BlueXP控制台中，使组织能够无缝发现其内部部署的 VMware vCenter 和ONTAP存储系统。一旦发现，管理员可以定义资源分组、创建灾难恢复计划、将其与适当的资源关联，以及启动或测试故障转移和故障回复操作。 NetApp SnapMirror提供高效的块级复制，确保 DR 站点通过增量更新与生产环境保持同步。这使得恢复点目标 (RPO) 可以低至五分钟。

BlueXP DRaaS 还支持无中断灾难恢复测试。利用 ONTAP 的FlexClone技术，它可以从最新复制的快照中创建节省空间的 NFS 数据存储临时副本，而不会影响生产工作负载或产生额外的存储成本。测试完成后，可以轻松拆除环境，同时保留复制数据的完整性。

如果发生实际故障转移， BlueXP会协调恢复过程，在最少的用户干预下自动在指定的 DR 站点启动受保护的虚拟机。当主站点恢复时，该服务会逆转SnapMirror关系并将任何更改复制回原始站点，从而实现平稳且可控的故障恢复。

与传统的灾难恢复解决方案相比，所有这些功能的成本都低得多。

image::vmw-vcf-dr-bxp-nfs-001.png[使用BlueXP 的DR 架构图]



== 入门

要开始使用BlueXP disaster recovery，请使用BlueXP控制台，然后访问该服务。

. 登录BlueXP。
. 从BlueXP左侧导航中，选择保护 > 灾难恢复。
. 出现BlueXP disaster recovery仪表板。
+
image::vmw-vcf-dr-bxp-nfs-002.png[BlueXP DR 仪表板]



在配置灾难恢复计划之前，请确保以下事项link:https://docs.netapp.com/us-en/bluexp-disaster-recovery/get-started/dr-prerequisites.html["先决条件"]满足：

* BlueXP Connector 在NetApp BlueXP中设置。
* BlueXP连接器实例与源和目标工作负载域 vCenter 和存储系统具有连接。
* NetApp Data ONTAP集群提供存储 NFS 或 VMFS 数据存储区。
* BlueXP中添加了为 VMware 托管 NFS 或 VMFS 数据存储区的本地NetApp存储系统。
* 使用 DNS 名称时应该进行 DNS 解析。否则，请使用 vCenter 的 IP 地址。
* SnapMirror复制是为指定的基于 NFS 或 VMFS 的数据存储库卷配置的。
* 确保环境具有受支持的 vCenter Server 和 ESXi 服务器版本。


一旦源站点和目标站点之间建立了连接，请继续执行配置步骤，这需要几次点击和大约 3 到 5 分钟的时间。

注意： NetApp建议在目标站点或第三个站点部署BlueXP连接器，以便BlueXP连接器可以通过网络与源资源和目标资源进行通信。

在此演示中，工作负载域配置了ONTAP NFS 存储。对于基于 VMFS 的数据存储，工作流程方面的步骤保持不变。

image::vmw-vcf-dr-bxp-nfs-003.png[BlueXP详细的 DR 仪表板]



== BlueXP disaster recovery配置

准备灾难恢复的第一步是发现并将源 vCenter 和存储资源添加到BlueXP disaster recovery。

打开BlueXP控制台并从左侧导航中选择保护 > 灾难恢复。选择“发现 vCenter 服务器”或使用顶部菜单，选择“站点”>“添加”>“添加 vCenter”。

添加以下平台：

* 源工作负载域 vCenter
* 目标工作负载域 vCenter。


一旦添加了 vCenter，就会触发自动发现。



== 配置源站点阵列和目标站点阵列之间的存储复制

SnapMirror在NetApp环境中提供数据复制。SnapMirror复制基于NetApp Snapshot® 技术构建，非常高效，因为它仅复制自上次更新以来已更改或添加的块。可以使用NetApp OnCommand® System Manager 或ONTAP CLI 轻松配置SnapMirror 。如果预先配置了集群和 SVM 对等连接， BlueXP DRaaS 还会创建SnapMirror关系。

对于主存储没有完全丢失的情况， SnapMirror提供了一种重新同步主站点和 DR 站点的有效方法。SnapMirror可以重新同步两个站点，只需反转SnapMirror关系即可将更改的数据或新数据从 DR 站点传回主站点。这意味着BlueXP DRaaS 中的复制计划可以在故障转移后在任一方向重新同步，而无需重新复制整个卷。如果以相反方向重新同步关系，则只有自上次成功同步 Snapshot 副本以来写入的新数据才会发送回目标。


NOTE: 如果已经通过 CLI 或系统管理器为卷配置了SnapMirror关系， BlueXP DRaaS 将获取该关系并继续其余工作流操作。



== 如何设置 VMware 灾难恢复

对于任何给定的应用程序，创建SnapMirror复制的过程都是相同的。该过程可以是手动的，也可以是自动的。最简单的方法是利用BlueXP DRaaS，只要满足以下两个条件，它就能自动执行相同的操作：

* 源集群和目标集群具有对等关系。
* 源 SVM 和目标 SVM 具有对等关系。


image::vmw-vcf-dr-bxp-nfs-004.png[BlueXP资源映射]

BlueXP还提供了另一种配置SnapMirror复制的选项，即通过简单地将环境中的源ONTAP系统拖放到目标上来触发指导其余过程的向导。



== BlueXP disaster recovery能为您做什么？

添加源站点和目标站点后， BlueXP disaster recovery将执行自动深度发现并显示虚拟机及其相关元数据。BlueXP disaster recovery还会自动检测虚拟机使用的网络和端口组并填充它们。

image::vmw-vcf-dr-bxp-nfs-005.png[BlueXP网站]

添加站点后，通过从下拉菜单中选择源和目标 vCenter 平台来配置复制计划，并选择要包含在计划中的资源组，以及应用程序如何恢复和启动的分组以及集群和网络的映射。要定义恢复计划，请导航到“*复制计划*”选项卡并单击“*添加计划*”。

在此步骤中，可以将虚拟机分组到资源组中。BlueXP disaster recovery资源组允许您将一组依赖的虚拟机分组为逻辑组，这些逻辑组包含可在恢复时执行的启动顺序和启动延迟。还可以使用资源组选项卡创建资源组。

首先，选择源 vCenter，然后选择目标 vCenter。

image::vmw-vcf-dr-bxp-nfs-006.png[BlueXP目标 vCenter]

下一步是选择现有的资源组。如果没有创建资源组，则向导将帮助根据恢复目标对所需的虚拟机进行分组（基本上创建功能资源组）。这也有助于定义如何恢复应用程序虚拟机的操作顺序。

image::vmw-vcf-dr-bxp-nfs-007.png[BlueXP选择要保护的虚拟机]


NOTE: 资源组允许使用拖放功能设置启动顺序。它可用于轻松修改恢复过程中虚拟机的启动顺序。

一旦通过复制计划创建了资源组，下一步就是选择蓝图或映射，以便在发生灾难时恢复虚拟机和应用程序。在此步骤中，指定源环境中的资源如何映射到目标。这包括计算资源、虚拟网络、IP 定制、前脚本和后脚本、启动延迟、应用程序一致性等。有关详细信息，请参阅link:https://docs.netapp.com/us-en/bluexp-disaster-recovery/use/drplan-create.html#map-source-resources-to-the-target["创建复制计划"]。如先决条件中所述，可以预先配置SnapMirror复制，或者 DRaaS 可以使用在创建复制计划期间指定的 RPO 和保留计数来配置它。

注意：默认情况下，测试和故障转移操作使用相同的映射参数。要为测试环境设置不同的映射，请取消选中“对故障转移和测试映射使用相同的映射”复选框，然后选择测试映射选项。资源映射完成后，单击下一步。

image::vmw-vcf-dr-bxp-nfs-008.png[BlueXP资源映射]

完成后，检查创建的映射，然后单击添加计划。

image::vmw-vcf-dr-bxp-nfs-009.png[BlueXP资源映射审查]


NOTE: 复制计划中可以包含来自不同卷和 SVM 的虚拟机。根据 VM 的放置位置（位于同一卷上、同一 SVM 内的单独卷上、不同 SVM 上的单独卷上）， BlueXP disaster recovery会创建一致性组快照。

image::vmw-vcf-dr-bxp-nfs-010.png[BlueXP replication计划]

一旦创建计划，就会触发一系列验证，并根据选择配置SnapMirror复制和计划。

image::vmw-vcf-dr-bxp-nfs-011.png[BlueXP作业监控]

BlueXP DRaaS 包含以下工作流程：

* 测试故障转移（包括定期自动模拟）
* 清理故障转移测试
* 故障转移：
+
** 计划迁移（扩展一次性故障转移的用例）
** 灾难恢复


* 故障回复


image::vmw-vcf-dr-bxp-nfs-012.png[BlueXP replication计划操作]



== 测试故障转移

BlueXP DRaaS 中的测试故障转移是一种操作程序，允许 VMware 管理员在不中断生产环境的情况下全面验证其恢复计划。

image::vmw-vcf-dr-bxp-nfs-013.png[BlueXP replication计划测试故障转移]

BlueXP DRaaS 结合了在测试故障转移操作中选择快照作为可选功能的能力。此功能允许 VMware 管理员验证环境中最近所做的任何更改是否都复制到目标站点，从而在测试期间出现。这些变化包括对 VM 客户操作系统的补丁。

image::vmw-vcf-dr-bxp-nfs-014.png[BlueXP replication计划测试故障转移确认]

当 VMware 管理员运行测试故障转移操作时， BlueXP DRaaS 会自动执行以下任务：

* 触发SnapMirror关系，使用生产站点上所做的任何最新更改来更新目标站点上的存储。
* 在 DR 存储阵列上创建FlexVol卷的NetApp FlexClone卷。
* 将FlexClone卷中的数据存储库连接到 DR 站点的 ESXi 主机。
* 将虚拟机网络适配器连接到映射期间指定的测试网络。
* 按照 DR 站点的网络定义重新配置 VM 客户操作系统网络设置。
* 执行复制计划中存储的任何自定义命令。
* 按照复制计划中定义的顺序启动虚拟机。


image::vmw-vcf-dr-bxp-nfs-015.png[BlueXP replication计划测试故障转移结果]



== 清理故障转移测试操作

清理故障转移测试操作在复制计划测试完成并且 VMware 管理员响应清理提示后发生。

image::vmw-vcf-dr-bxp-nfs-016.png[BlueXP replication计划测试故障转移清理]

此操作将虚拟机 (VM) 和复制计划的状态重置为就绪状态。当 VMware 管理员执行恢复操作时， BlueXP DRaaS 完成以下过程：

. 它关闭用于测试的FlexClone副本中的每个恢复的虚拟机。
. 它会删除在测试期间用于呈现恢复的虚拟机的 FlexClone卷。




== 计划迁移和故障转移

BlueXP DRaaS 有两种执行实际故障转移的方法：计划迁移和故障转移。第一种方法，计划迁移，将虚拟机关闭和存储复制同步纳入到恢复或有效地将虚拟机移动到目标站点的过程中。计划迁移需要访问源站点。第二种方法，故障转移，是计划内/非计划内故障转移，其中虚拟机从上次能够完成的存储复制间隔在目标站点恢复。根据解决方案中设计的 RPO，在 DR 场景中可能会出现一定量的数据丢失。

image::vmw-vcf-dr-bxp-nfs-017.png[BlueXP replication计划故障转移操作]

image::vmw-vcf-dr-bxp-nfs-018.png[BlueXP replication计划故障转移操作确认]

当 VMware 管理员执行故障转移操作时， BlueXP DRaaS 会自动执行以下任务：

* 中断并故障转移NetApp SnapMirror关系。
* 将复制的数据存储连接到 DR 站点的 ESXi 主机。
* 将 VM 网络适配器连接到适当的目标站点网络。
* 按照目标站点的网络定义重新配置 VM 客户操作系统网络设置。
* 执行复制计划中存储的任何自定义命令（如果有）。
* 按照复制计划中定义的顺序启动虚拟机。


image::vmw-vcf-dr-bxp-nfs-019.png[vSphere Client - 虚拟机已启动]



== 故障回复

故障回复是一种可选过程，可在恢复后恢复源站点和目标站点的原始配置。

image::vmw-vcf-dr-bxp-nfs-020.png[BlueXP replication计划故障回复操作]

当 VMware 管理员准备将服务恢复到原始源站点时，他们可以配置并运行故障回复程序。


NOTE: BlueXP DRaaS 在反转复制方向之前将任何更改复制（重新同步）回原始源虚拟机。

此过程从已完成故障转移到目标的关系开始，并涉及以下步骤：

* 关闭并取消注册虚拟机，并卸载目标站点上的卷。
+
image::vmw-vcf-dr-bxp-nfs-021.png[vSphere Client - 最近任务]

* 打破原始源上的SnapMirror关系，使其变为读/写。
* 重新同步SnapMirror关系以逆转复制。
* 在源上安装卷，启动并注册源虚拟机。
+
image::vmw-vcf-dr-bxp-nfs-022.png[vSphere Client - 虚拟机已启动]



有关访问和配置BlueXP DRaaS 的更多详细信息，请参阅link:https://docs.netapp.com/us-en/bluexp-disaster-recovery/get-started/dr-intro.html["了解适用于 VMware 的BlueXP灾难恢复"]。



== 监控和仪表板

从BlueXP或ONTAP CLI，您可以监控相应数据存储卷的复制健康状态，并且可以通过作业监控跟踪故障转移或测试故障转移的状态。

image::vmw-vcf-dr-bxp-nfs-023.png[BlueXP作业监控]


NOTE: 如果某项工作当前正在进行或排队，而您希望停止它，则可以选择取消它。

使用BlueXP disaster recovery仪表板，可以自信地评估灾难恢复站点和复制计划的状态。这使管理员能够快速识别健康、断开连接或降级的站点和计划。

image::vmw-vcf-dr-bxp-nfs-024.png[BlueXP更新了 dr deashboard]

这为处理量身定制的灾难恢复计划提供了强大的解决方案。当发生灾难并决定激活 DR 站点时，可以按计划进行故障转移或单击按钮进行故障转移。
