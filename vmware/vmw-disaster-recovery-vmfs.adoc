---
sidebar: sidebar 
permalink: vmware/vmw-disaster-recovery-vmfs.html 
keywords: dr, draas, bluexp, disaster recovery, vmfs datastore 
summary: 本文档的此部分介绍了BlueXP DRaaS 的配置，以便为本地 VMware VM 设置灾难恢复到另一个指定站点。 
---
= 使用BlueXP disaster recovery
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
在此用例中，我们概述了使用BlueXP disaster recovery为使用 VMware 虚拟机文件系统 (VMFS) 数据存储的本地 VMware VM 设置灾难恢复的过程。此过程包括设置BlueXP帐户和连接器、在ONTAP系统之间建立SnapMirror复制、与 VMware vCenter 集成以及自动执行故障转移和故障恢复操作。

使用从生产站点到灾难恢复站点的块级复制进行灾难恢复是一种有弹性且经济高效的方法，可以保护工作负载免受站点中断和数据损坏事件（如勒索软件攻击）的影响。借助NetApp SnapMirror复制，使用 VMFS 数据存储区运行本地ONTAP系统的 VMware 工作负载可以复制到 VMware 所在的指定恢复数据中心的另一个ONTAP存储系统



== 简介

本文档的此部分介绍了BlueXP DRaaS 的配置，以便为本地 VMware VM 设置灾难恢复到另一个指定站点。作为此设置的一部分， BlueXP帐户、 BlueXP连接器、 BlueXP工作区内添加的ONTAP阵列是实现从 VMware vCenter 到ONTAP存储的通信所必需的。此外，本文档详细介绍了如何配置站点之间的复制以及如何设置和测试恢复计划。最后一部分介绍了如何执行完整站点故障转移以及在主站点恢复并在线购买后如何进行故障恢复。

使用集成到NetApp BlueXP控制台中的BlueXP disaster recovery服务，客户可以发现其内部部署的 VMware vCenter 以及ONTAP存储、创建资源组、创建灾难恢复计划、将其与资源组关联，以及测试或执行故障转移和故障恢复。SnapMirror提供存储级块复制，使两个站点保持最新的增量更改，从而使 RPO 达到最长 5 分钟。还可以将 DR 过程模拟为常规演习，而不会影响生产和复制的数据存储或产生额外的存储成本。BlueXP disaster recovery利用 ONTAP 的FlexClone技术，从 DR 站点上最后复制的快照创建 VMFS 数据存储的节省空间的副本。一旦 DR 测试完成，客户就可以简单地删除测试环境，而不会对实际复制的生产资源产生任何影响。当需要（计划内或计划外）进行实际故障转移时，只需单击几下， BlueXP disaster recovery服务就会协调所需的所有步骤，自动在指定的灾难恢复站点上启动受保护的虚拟机。该服务还将逆转与主站点的SnapMirror关系，并在需要时将任何更改从辅助站点复制到主站点以进行故障恢复操作。与其他知名替代方案相比，所有这些都只需花费极少的成本即可实现。

image:dr-draas-vmfs-030.png["该图显示输入/输出对话框或表示书面内容"]



== 入门

要开始使用BlueXP disaster recovery，请使用BlueXP控制台，然后访问该服务。

. 登录BlueXP。
. 从BlueXP左侧导航中，选择保护 > 灾难恢复。
. 出现BlueXP disaster recovery仪表板。


image:dr-draas-vmfs-001.png["该图显示输入/输出对话框或表示书面内容"]

配置灾难恢复计划之前，请确保满足以下先决条件：

* BlueXP Connector 在NetApp BlueXP中设置。连接器应部署在 AWS VPC 中。
* BlueXP连接器实例与源和目标 vCenter 和存储系统具有连接。
* BlueXP中添加了托管 VMware VMFS 数据存储区的本地NetApp存储系统。
* 使用 DNS 名称时应该进行 DNS 解析。否则，请使用 vCenter 的 IP 地址。
* SnapMirror复制是为指定的基于 VMFS 的数据存储卷配置的。


一旦源站点和目标站点之间建立连接，请继续执行配置步骤，这大约需要 3 到 5 分钟。


NOTE: NetApp建议在灾难恢复站点或第三个站点部署BlueXP连接器，以便BlueXP连接器可以在实际中断或自然灾害期间通过网络与源资源和目标资源进行通信。

image:dr-draas-vmfs-002.png["该图显示输入/输出对话框或表示书面内容"]


NOTE: 在撰写本文档时，对本地到本地 VMFS 数据存储的支持处于技术预览阶段。基于 FC 和 ISCSI 协议的 VMFS 数据存储均支持该功能。



== BlueXP disaster recovery配置

准备灾难恢复的第一步是发现并将内部部署 vCenter 和存储资源添加到BlueXP disaster recovery。


NOTE: 确保ONTAP存储系统已添加到画布内的工作环境中。打开BlueXP控制台并从左侧导航中选择 *保护 > 灾难恢复*。选择*发现 vCenter 服务器*或使用顶部菜单，选择*站点 > 添加 > 添加 vCenter*。

image:dr-draas-vmfs-003.png["该图显示输入/输出对话框或表示书面内容"]

添加以下平台：

* *来源*。本地 vCenter。


image:dr-draas-vmfs-004.png["该图显示输入/输出对话框或表示书面内容"]

* *目的地*。VMC SDDC vCenter。


image:dr-draas-vmfs-005.png["该图显示输入/输出对话框或表示书面内容"]

一旦添加了 vCenter，就会触发自动发现。



== 配置源站点和目标站点之间的存储复制

SnapMirror利用ONTAP快照来管理从一个位置到另一个位置的数据传输。首先，基于源卷快照的完整副本被复制到目标位置以执行基线同步。当源处发生数据变化时，会创建一个新的快照并将其与基线快照进行比较。然后将发现已更改的块复制到目标位置，其中较新的快照成为当前基线或最新的公共快照。这使得该过程可以重复，并且增量更新可以发送到目的地。

建立SnapMirror关系后，目标卷处于联机只读状态，因此仍然可访问。SnapMirror与物理存储块一起工作，而不是在文件或其他逻辑级别上工作。这意味着目标卷是源的相同副本，包括快照、卷设置等。如果源卷正在使用ONTAP空间效率功能（例如数据压缩和重复数据删除），则复制的卷将保留这些优化。

中断SnapMirror关系会使目标卷变得可写，并且通常在使用SnapMirror将数据同步到 DR 环境时用于执行故障转移。SnapMirror足够复杂，可以允许故障转移站点上更改的数据有效地重新同步回主系统（如果主系统稍后恢复在线），然后允许重新建立原始的SnapMirror关系。



== 如何设置 VMware 灾难恢复

对于任何给定的应用程序，创建SnapMirror复制的过程都是相同的。该过程可以是手动的，也可以是自动的。最简单的方法是利用BlueXP配置SnapMirror复制，只需将环境中的源ONTAP系统拖放到目标上即可触发指导其余过程的向导。

image:dr-draas-vmfs-006.png["该图显示输入/输出对话框或表示书面内容"]

如果满足以下两个条件， BlueXP DRaaS 也可以自动执行相同的操作：

* 源集群和目标集群具有对等关系。
* 源 SVM 和目标 SVM 具有对等关系。


image:dr-draas-vmfs-007.png["该图显示输入/输出对话框或表示书面内容"]


NOTE: 如果已经通过 CLI 为卷配置了SnapMirror关系， BlueXP DRaaS 将获取该关系并继续其余工作流操作。


NOTE: 除了上述方法之外，还可以通过ONTAP CLI 或系统管理器创建SnapMirror复制。无论使用SnapMirror同步数据的方法是什么， BlueXP DRaaS 都会协调工作流程，实现无缝、高效的灾难恢复操作。



== BlueXP disaster recovery能为您做什么？

添加源站点和目标站点后， BlueXP disaster recovery将执行自动深度发现并显示虚拟机及其相关元数据。BlueXP disaster recovery还会自动检测虚拟机使用的网络和端口组并填充它们。

image:dr-draas-vmfs-008.png["该图显示输入/输出对话框或表示书面内容"]

添加站点后，虚拟机可以分组到资源组中。BlueXP disaster recovery资源组允许您将一组依赖的虚拟机分组为逻辑组，这些逻辑组包含可在恢复时执行的启动顺序和启动延迟。要开始创建资源组，请导航到*资源组*并单击*创建新资源组*。

image:dr-draas-vmfs-009.png["该图显示输入/输出对话框或表示书面内容"]


NOTE: 在创建复制计划时也可以创建资源组。

可以通过简单的拖放机制在创建资源组期间定义或修改虚拟机的启动顺序。

image:dr-draas-vmfs-010.png["该图显示输入/输出对话框或表示书面内容"]

创建资源组后，下一步是创建执行蓝图或在发生灾难时恢复虚拟机和应用程序的计划。如先决条件中所述，可以预先配置SnapMirror复制，或者 DRaaS 可以使用在创建复制计划期间指定的 RPO 和保留计数来配置它。

image:dr-draas-vmfs-011.png["该图显示输入/输出对话框或表示书面内容"]

image:dr-draas-vmfs-012.png["该图显示输入/输出对话框或表示书面内容"]

通过从下拉菜单中选择源和目标 vCenter 平台来配置复制计划，并选择要包含在计划中的资源组，以及如何恢复和启动应用程序的分组以及集群和网络的映射。要定义恢复计划，请导航到“*复制计划*”选项卡并单击“*添加计划*”。

首先，选择源 vCenter，然后选择目标 vCenter。

image:dr-draas-vmfs-013.png["该图显示输入/输出对话框或表示书面内容"]

下一步是选择现有的资源组。如果没有创建资源组，则向导将帮助根据恢复目标对所需的虚拟机进行分组（基本上创建功能资源组）。这也有助于定义如何恢复应用程序虚拟机的操作顺序。

image:dr-draas-vmfs-014.png["该图显示输入/输出对话框或表示书面内容"]


NOTE: 资源组允许使用拖放功能设置启动顺序。它可用于轻松修改恢复过程中虚拟机的启动顺序。


NOTE: 资源组内的各个虚拟机按照顺序依次启动。两个资源组并行启动。

如果未事先创建资源组，则以下屏幕截图显示了根据组织要求过滤虚拟机或特定数据存储的选项。

image:dr-draas-vmfs-015.png["该图显示输入/输出对话框或表示书面内容"]

选择资源组后，创建故障转移映射。在此步骤中，指定源环境中的资源如何映射到目标。这包括计算资源、虚拟网络。IP 定制、前脚本和后脚本、启动延迟、应用程序一致性等。有关详细信息，请参阅link:https://docs.netapp.com/us-en/bluexp-disaster-recovery/use/drplan-create.html#map-source-resources-to-the-target["创建复制计划"]。

image:dr-draas-vmfs-016.png["该图显示输入/输出对话框或表示书面内容"]


NOTE: 默认情况下，测试和故障转移操作使用相同的映射参数。要对测试环境应用不同的映射，请取消选中复选框后选择测试映射选项，如下所示：

image:dr-draas-vmfs-017.png["该图显示输入/输出对话框或表示书面内容"]

资源映射完成后，单击下一步。

image:dr-draas-vmfs-018.png["该图显示输入/输出对话框或表示书面内容"]

选择重复类型。简单来说，选择迁移（使用故障转移的一次性迁移）或重复连续复制选项。在本演练中，选择了“复制”选项。

image:dr-draas-vmfs-019.png["该图显示输入/输出对话框或表示书面内容"]

完成后，检查创建的映射，然后单击添加计划。

image:dr-draas-vmfs-020.png["该图显示输入/输出对话框或表示书面内容"]

image:dr-draas-vmfs-021.png["该图显示输入/输出对话框或表示书面内容"]

创建复制计划后，可以根据需求通过选择故障转移选项、测试故障转移选项或迁移选项来执行故障转移。BlueXP disaster recovery确保每 30 分钟按照计划执行复制过程。在故障转移和测试故障转移选项期间，您可以使用最新的SnapMirror Snapshot 副本，也可以从时间点 Snapshot 副本中选择特定的 Snapshot 副本（根据SnapMirror的保留策略）。如果发生勒索软件等损坏事件，其中最新的副本已被破坏或加密，则时间点选项会非常有用。BlueXP disaster recovery显示所有可用的恢复点。

image:dr-draas-vmfs-022.png["该图显示输入/输出对话框或表示书面内容"]

要使用复制计划中指定的配置触发故障转移或测试故障转移，请单击“*故障转移*”或“*测试故障转移*”。

image:dr-draas-vmfs-023.png["该图显示输入/输出对话框或表示书面内容"]



== 故障转移或测试故障转移操作期间会发生什么？

在测试故障转移操作期间， BlueXP disaster recovery使用最新的 Snapshot 副本或目标卷的选定快照在目标ONTAP存储系统上创建FlexClone卷。


NOTE: 测试故障转移操作会在目标ONTAP存储系统上创建克隆卷。


NOTE: 运行测试恢复操作不会影响SnapMirror复制。

image:dr-draas-vmfs-024.png["该图显示输入/输出对话框或表示书面内容"]

在此过程中， BlueXP disaster recovery不会映射原始目标卷。相反，它会根据选定的快照创建一个新的FlexClone卷，并将支持该FlexClone卷的临时数据存储映射到 ESXi 主机。

image:dr-draas-vmfs-025.png["该图显示输入/输出对话框或表示书面内容"]

image:dr-draas-vmfs-026.png["该图显示输入/输出对话框或表示书面内容"]

当测试故障转移操作完成时，可以使用“清理故障转移测试”触发清理操作。在此操作期间， BlueXP disaster recovery会破坏操作中使用的FlexClone卷。

当真正的灾难事件发生时， BlueXP disaster recovery将执行以下步骤：

. 中断站点之间的SnapMirror关系。
. 重新签名后挂载 VMFS 数据存储卷以供立即使用。
. 注册虚拟机
. 启动虚拟机


image:dr-draas-vmfs-027.png["该图显示输入/输出对话框或表示书面内容"]

一旦主站点启动并运行， BlueXP disaster recovery就会启用SnapMirror的反向重新同步并启用故障恢复，这些操作只需单击按钮即可执行。

image:dr-draas-vmfs-028.png["该图显示输入/输出对话框或表示书面内容"]

如果选择迁移选项，则它将被视为计划内的故障转移事件。在这种情况下，将触发额外的步骤，即关闭源站点的虚拟机。其余步骤与故障转移事件相同。

从BlueXP或ONTAP CLI，您可以监控相应数据存储卷的复制健康状态，并且可以通过作业监控跟踪故障转移或测试故障转移的状态。

image:dr-draas-vmfs-029.png["该图显示输入/输出对话框或表示书面内容"]

这为处理量身定制的灾难恢复计划提供了强大的解决方案。当发生灾难并决定激活 DR 站点时，可以按计划进行故障转移或单击按钮进行故障转移。

要了解有关此过程的更多信息，请随意观看详细的演示视频或使用link:https://netapp.github.io/bluexp-draas-vmfs-simulator/?frame-0.1["解决方案模拟器"]。
